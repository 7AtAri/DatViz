---
title: "Report"
header-includes:
  - \usepackage[ngerman]{babel}
  - \DeclareUnicodeCharacter{308}{oe}  
author: "Nourhan Omar, Vipin Singh, Sara Wahl"
date: "`r Sys.Date()`"

encoding: utf8
output: 
  bookdown::html_document2:
    css: style.css
    toc: true
    toc_float: yes
    code_folding: hide
  bookdown::pdf_document2:
    toc: false
    keep_tex: true
---
```{r setup, include=FALSE}
params <- list(html=knitr::is_html_output())
knitr::opts_chunk$set(echo = params$html)
rm(list = ls(all.names = TRUE)) # reset the environment
source("Setup.R")
```


(ref:latexInCaption) A caption can contain _underscores_ and $\sqrt v$ formulae.

# Introduction

For our data visualization project we were searching for a dataset that not only holds tabular data but also images. The idea was to use image data to train and visualize the insides of a neural network but also investigate relationships in tabular data and connect or compare the findings. We were happy to find a dataset that fit our wishes on Kaggle, and originally was used for the *PetFinder.my Adoption Prediction* challenge.

# The Dataset

todo: describe the dataset:

- number and properties of variables
- for our project, we only used the train data because the test data does not have the AdoptionSpeed column, since this had to be predicted in the challenge the dataset was originally used for.
- amount of data points 
- When accessing the dataset, we realized it also already had sentiment analysis data which was run on the description column.
- necessary preprocessing


```{r variables overview, echo=FALSE}
na_ratio<-sum(is.na(petdata)==TRUE)/(dim(petdata)[1]*dim(petdata)[2])# ratio of NAs among all datapoints
print(na_ratio*100)
print("% of NAs among all datapoints")# percentage of NAs in data

```
# Distribution of Variables and their Correlations 

To get an overview, we used a frequency plot for the levels of categorical variables and a pairs plot with scatterplots and correlations, as well as histograms on the 
diagonal. 

```{r categorical variables frequencies, fig.width=10, fig.height=8, echo= FALSE}

inspect_cat(petdata[,!(names(petdata)%in%c("ColorID1","ColorID2","ColorID3","PetID", "Name", "Description", "RescuerID", "StateID"))])%>% 
  show_plot(label_size=0.1, col_palette=5,label_color="black") +
  labs(title = "Frequency in categorical levels in Petdata",
       subtitle = "Grey segments are NAs") +
  theme(plot.title = element_text(face = "bold"),
    plot.background = element_rect(fill = "white"),
    panel.grid.major = element_line(color = "white"),
    #panel.border=element_rect(margin(0.9,0,0,0)),
    strip.background = element_blank(),
    axis.text.y.left=element_text(size = 11, hjust=1),
    plot.margin = margin(21,17,17,17))
```
Therefore the Sentiment Scores and the Adoption Speed variable were factorized, and in the case of the Sentiment Scores also binned (see source file) from 0.1 steps to the five factors negative, moderately negative, neutral, moderately positive, and positive.
Categorical variables that contain IDs and names as well as descriptions were dropped.  
```{r numerical variables pairs plot,fig.width=10, fig.height=8, echo= FALSE}

petdata$ColorID1_num<-as.numeric(petdata$ColorID1)

# save following plot in png format in current directory
#png(file="pairs_and_corr.png", width=1800, height=1200,res=200)

par(mgp=c(0,0.3,0),mar=c(0,0,0,0)+0.1)
pairs.panels(petdata[c("Age", "Fee", "Quantity", "VideoAmt", "PhotoAmt",
                       "SentimentMagnitude", "AdoptionSpeed", "SentimentScore", "ColorID1_num")], 
             hist.col="darkblue",
             pch=23,
             main = "Pairs and Correlation Plot of Numeric Variables",
             cex.cor=0.6, 
             cex=0.6, 
             cex.labels=0.85,
             jiggle=TRUE,
             factor=1,
             ellipses = FALSE,
             smooth= FALSE,
             density = FALSE,
             rug=FALSE,
             stars=TRUE, 
             #bg=c("yellow","orange","red","purple","blue")[petdata$AdoptionSpeed],
             bg=c("purple","#FFDB6D")[petdata$Type], #
             #bg=c("green","red","yellow")[petdata$Gender],
             lwd=0.2,
             cex.axis = 0.8,
             tck=-0.08,
             las=1,
             oma=c(1,1.5,8,2))

# save the file:
#dev.off()
#getOption("device")
#dev.cur()

```

```{r legend, fig.width=10, fig.height=1, echo=FALSE}
par(mgp=c(0,0,0),mar=c(0,1,0.8,0)+0.1)
plot(NULL ,xaxt='n',yaxt='n',bty='n',ylab='',xlab='', xlim=0:1, ylim=0:1)
legend("topleft", legend =c('Dogs', 'Cats'), pch=16, pt.cex=1.5, cex=0.8, bty='n',
   col = c('#FFDB6D', 'purple'), horiz = TRUE)
```


Some categorical variables were used with their numeric representations, since these can be read numerically. For example Adoption Speed, that is an ordinal variable with 5 factors and Color ID1, since the color scale goes from dark to light colors. 

We can see the correlations of the numerical variables with their significance levels displayed as stars next to the numbers. On the diagonal, we see the histograms of the displayed variables. Most of them seem to be power law distributions. The pairs plots in the lower half are displaying scatterplots. Its purple points are the dogs, while the orange points are the cats. This makes it possible to see some differences between the two pet types of our dataset, for example that the cats seem to not get as old as the dogs. Also we can see some structural conspicuities between some variables, for example that the fee gets lower if the animals are older. Or that animals with a very fast adoption speed have almost no negative sentiment scores. 


# Data Exploration

## Distribution of Catbreeds
```{r catbreeds, fig.width=10, fig.height=8, echo=FALSE}
par(mfrow=c(1,2))
par(mar = c(1, 7, 1, 1)+0.1, mgp=c(0,0.3,-0.2), oma = c(1, 1, 1, 1))

table_catbreeds<-(table(cats$Breed1))
table_catbreeds<-table_catbreeds[order(table_catbreeds)]
df_catbreeds<-data.frame(table_catbreeds)

max_breed_cats<-max(table(cats$Breed1))

barplot(df_catbreeds$Freq[df_catbreeds$Freq>5],
        las = 1,
        #cex.lab = 1,
        horiz = TRUE, 
        cex.names=0.7, 
        xlim = c(0, 4000),
        cex.axis=0.7,
        names=df_catbreeds$Var1[df_catbreeds$Freq>5],
        col="darkred",
        #main="Frequencies (>5) of Cat Breeds in the Petdata Dataset")
)

barplot(df_catbreeds$Freq[df_catbreeds$Freq>5 & df_catbreeds$Var1!="Domestic Short Hair" & df_catbreeds$Var1!="Domestic Medium Hair"],
        las = 1,
        #cex.lab = 1,
        horiz = TRUE, 
        cex.names=0.7, 
        xlim = c(0, 400),
        cex.axis=0.7,
        names=df_catbreeds$Var1[df_catbreeds$Freq>5& df_catbreeds$Var1!="Domestic Short Hair"& df_catbreeds$Var1!="Domestic Medium Hair"],
        col="darkred",
        #main="Frequencies (>5) of Cat Breeds in the Petdata Dataset")
)

title(main = "Cat Breeds - Frequencies (>5) and without Domestic Short and Medium Hair", 
      line = -1, 
      cex.main=1,
      font.main=2,
      #col.main="darkorange",
      outer = TRUE,
      adj=0.6)

```

## Distribution of Dogbreeds

```{r dogbreeds,fig.width=10, fig.height=10,echo=FALSE}
par(mfrow=c(1,2))
par(mar = c(1, 7, 1, 1)+0.1, mgp=c(0,0.3,-0.2), oma = c(1, 1, 1, 1))

table_dogbreeds<-(table(dogs$Breed1))
table_dogbreeds<-table_dogbreeds[order(table_dogbreeds)]
df_dogbreeds<-data.frame(table_dogbreeds)

max_table<-max(table(dogs$Breed1))

barplot(df_dogbreeds$Freq[df_dogbreeds$Freq>5],
        las = 1,
        cex.lab = 1,
        horiz = TRUE, 
        cex.names=0.7, 
        xlim = c(0, 7000),
        cex.axis=0.75,
        names=df_dogbreeds$Var1[df_dogbreeds$Freq>5],
        col="darkred",
        #main="Frequencies (>5) of Dog Breeds in the Petdata Dataset"
)
# dogbreeds without mixed breed
barplot(df_dogbreeds$Freq[df_dogbreeds$Freq>5 & df_dogbreeds$Var1!="Mixed Breed"],
        las = 1,
        #cex.lab = 1,
        horiz = TRUE, 
        cex.names=0.7, 
        xlim = c(0, 250),
        cex.axis=0.8,
        #bg="lightgrey",
        names=df_dogbreeds$Var1[df_dogbreeds$Freq>5& df_dogbreeds$Var1!="Mixed Breed"],
        col="darkred",
        #cex.main=1,
        #main="Frequencies (>5) of Dog Breeds in the Petdata Dataset")
)
title(main = "Dog Breeds - Frequencies (>5) / and without 'Mixed Breed'", 
      line = -1, 
      cex.main=1.1,
      font.main=2,
      #col.main="darkorange",
      outer = TRUE,
      adj=0.38)
```


## Maps for Locations of the Animals


## Sentiment Scores Exploration


```{r, sentiment scores, fig.width=10, fig.height=10, echo=FALSE}
# make the gradient background:
library(leaflet)
g <- make_gradient(
  deg = -180, n = 500, cols = brewer.pal(9, "RdBu")
)

# ----plots with gradient ---------------------


p2<-ggplot(data=subset(petdata, !is.na(SentimentScore)), 
           aes(SentimentScore, fct_rev(Health))) +
  annotation_custom(
    grob = g, xmin = Inf, xmax = -Inf, ymin = Inf, ymax = -Inf
  ) + 
  ggtitle("Pets Health Status for Sentiment Score") +
  geom_boxplot(alpha=0.2)+
  ylab("Health")+
  xlab("Sentiment Score")+
  xlim(-1.0,1.0)+
  theme(
    plot.margin=unit(c(0.6,0.8,0.8,0.6),"cm"),
    plot.title = element_text(color="black", size=10, face="bold"),
    axis.title.x = element_text(color="black", size=8),
    axis.title.y = element_text(color="black", size=8)
  )


p4<-ggplot(data=subset(petdata, !is.na(SentimentScore)), 
           aes(SentimentScore, fct_rev(AdoptionSpeed_fac))) +
  annotation_custom(
    grob = g, xmin = Inf, xmax = -Inf, ymin = Inf, ymax = -Inf
  ) + 
  ggtitle("Pets Adoption Speed for Sentiment Score") +
  geom_violin(alpha=0)+
  ylab("Adoption Speed")+
  xlab("Sentiment Score")+
  xlim(-1.0,1.0)+
  theme(
    plot.margin=unit(c(0.6,0.8,0.8,0.6),"cm"),
    plot.title = element_text(color="black", size=10, face="bold"),
    axis.title.x = element_text(color="black", size=8),
    axis.title.y = element_text(color="black", size=8)
  )

  
p3<-ggplot(data=subset(dogs, !is.na(SentimentScore)),
           aes(SentimentScore)) +
  annotation_custom(
    grob = g, xmin = Inf, xmax = -Inf, ymin = Inf, ymax = -Inf
  ) + 
  ggtitle("Dogs - Sentiment Scores Frequencies") +
  geom_bar(fill='black')+  #949996 ##838785 '#7c8781' , colour="black"
  xlab("Sentiment Score")+
  theme(
    plot.margin=unit(c(0.6,0.8,0.8,0.6),"cm"),
    plot.title = element_text(color="black", size=10, face="bold"),
    axis.title.x = element_text(color="black", size=8,),
    axis.title.y = element_text(color="black", size=8,)
  )

p1<-ggplot(data=subset(cats, !is.na(SentimentScore)),
           aes(SentimentScore))+
               #fill=Gender,
               #group=Gender)) +
  #scale_fill_brewer(palette="Greys")+
  annotation_custom(
    grob = g, xmin = Inf, xmax = -Inf, ymin = Inf, ymax = -Inf
  ) + 
  ggtitle("Cats - Sentiment Scores Frequencies") +
  geom_bar(fill='black')+
  xlab("Sentiment Score")+
  labs(fill = "Gender")+
  theme(
    plot.margin=unit(c(0.6,0.8,0.8,0.6),"cm"),
    plot.title = element_text(color="black", size=10, face="bold"),
    axis.title.x = element_text(color="black", size=8),
    axis.title.y = element_text(color="black", size=8),
    legend.key.size = unit(0.5, 'cm'), #change legend key size
    legend.key.height = unit(0.5, 'cm'), #change legend key height
    legend.key.width = unit(0.5, 'cm'), #change legend key width
    legend.title = element_text(size=7), #change legend title font size
    legend.text = element_text(size=7), #change legend text font size
    legend.direction = "horizontal",
    legend.position = "bottom"
  )


p5<-ggplot(data=subset(petdata, !is.na(SentimentScore)), 
           aes(SentimentScore, MaturitySize)) +
  annotation_custom(
    grob = g, xmin = Inf, xmax = -Inf, ymin = Inf, ymax = -Inf
  ) + 
  ggtitle("Pets Maturity Size for Sentiment Score") +
  geom_violin(alpha=0)+
  ylab("Maturity Size")+
  xlab("Sentiment Score")+
  xlim(-1.0,1.0)+
  theme(
    plot.margin=unit(c(0.6,0.8,0.8,0.6),"cm"),
    plot.title = element_text(color="black", size=10, face="bold"),
    axis.title.x = element_text(color="black", size=8),
    axis.title.y = element_text(color="black", size=8),
  )

p6<-ggplot(data=subset(petdata, !is.na(SentimentScore)), 
           aes(SentimentScore, Age)) +
  annotation_custom(
    grob = g, xmin = Inf, xmax = -Inf, ymin = Inf, ymax = -Inf
  ) + 
  ggtitle("Pets Age for Sentiment Score") +
  geom_jitter(alpha=0.3)+
  ylab("Age in Months")+
  xlab("Sentiment Score")+
  theme(
    plot.margin=unit(c(0.6,0.8,0.8,0.6),"cm"),
    plot.title = element_text(color="black", size=10, face="bold"),
    axis.title.x = element_text(color="black", size=8),
    axis.title.y = element_text(color="black", size=8)
  )


p7<-ggplot(data=subset(petdata, !is.na(SentimentScore)), 
  aes(SentimentScore, State)) +
  annotation_custom(
    grob = g, xmin = Inf, xmax = -Inf, ymin = Inf, ymax = -Inf
  ) + 
  ggtitle("Pet's State for Sentiment Score") +
  geom_boxplot(alpha=0)+
  ylab("State")+
  xlab("Sentiment Score")+
  xlim(-1.0,1.0)+
  theme(
    plot.margin=unit(c(0.6,0.8,0.8,0.6),"cm"),
    plot.title = element_text(color="black", size=10, face="bold"),
    axis.title.x = element_text(color="black", size=8),
    axis.title.y = element_text(color="black", size=8)
  )

grid.arrange(p1, p2, p3, p5, p6, p7,
             nrow=3, ncol=2, 
             top = "Exploring Sentiment in Descriptions",
             vp=viewport(width=0.9, height=0.9))
```

# Cluster and Neural Network Visuals

- clustering (hierarchical for categorical variables)


- r-tsne of neural net embedding vectors for images

![R-TSNE plot for the petdata images.](plots/tsne-2000.png)

We ran the images that come with the pet data through a Resnet-101 Network and visualized the embeddings with r-tsne. It clustered the cats and dogs very well (left/red: dogs, right/blue: cats), but also sorted the animals by color (top: light fur, bottom: dark fur) and even has captured some similarities that are common to both types in the middle, for example the spot where pictures of animals in cages are displayed. 



# Summary/Findings











------------- THE REST IS ONLY FOR KNOW HOW ON R-MARKDOWN ----------------------




# References

The R package **bookdown** is documented in an online book by its author Yihui Xie (2023). In this brief demo, I demonstrate some basic aspects of the use of the R package **bookdown** that took me some more time to figure out from that documentation. The package **bookdown** is based on the package **knitr** (see, e.g., https://yihui.org/knitr/), and the possibilities of that package can also be used. For example, it is possible to incorporate not only R code (like in this demo), but also, e.g., Python or Julia code with the respective code chunks.

In Chapter&nbsp;\@ref(sec:meinreflabel2) you find a figure with a simple caption that was created by the `fig.cap` entry in the chunk information, and a table that was created with function `knitr::kable`. In Chapter&nbsp;\@ref(sec:meinreflabel3) you find a figure whose caption contains underscores and a formula; because of these complications, the figure caption has to be defined as a reference (see above, "(ref:latexInCaption)") before it can be used in the chunk information; I have made it a personal convention to always define all such references at the top of the file. Such a reference can be used everywhere in the text. If you have more than one reference definition, always have an empty line between any two such definitions (there is only one here).

You can have unnumbered chapters (while most chapters are numbered), see the appendix.

 
With the **bookdown** package, it is easy to reference back an forth between sections, and to figures or tables that were created from code chunks. References to figures start with "fig:", references to tables with "tab:", and section references are entirely defined in the curly brackets after the heading, starting with "#".  The syntax for **bookdown** references is "\@ref(your reference target)",  see examples in this file. They are translated to the appropriate way of referencing for pdf or html files, as appropriate.





# Second chapter{#sec:meinreflabel2}

Table&nbsp;\@ref(tab:cor) shows the correlations in the dataset `swiss`.

```{r cor}
knitr::kable(round(cor(swiss),4), caption="The correlation matrix of the `swiss` data", booktabs=TRUE, linesep="")
```

Figure&nbsp;\@ref(fig:kde) shows a kernel density estimate of the proportion of males involved in agricultural occupations.

```{r kde, fig.cap="Proportion of males involved in agricultural occupations in 47 French speaking swiss provinces (1888). Kernel density estimate.", fig.height=3, fig.width=4}
plot(density(swiss$Agriculture), xlab="Agriculture")
```

# Third chapter{#sec:meinreflabel3}

Figure&nbsp;\@ref(fig:scat) shows a scatter plot with a more demanding figure caption.

```{r scat, fig.cap="(ref:latexInCaption)", fig.height=3, fig.width=4}
plot(Fertility~Agriculture, swiss)
```

# Final chapter
Your final chapter \textendash&nbsp;like your introductury chapter \textendash&nbsp;will be read by every reader. Both these chapters are therefore particularly important. 

Please note that this brief text focused on how to implement a report with the help of R package **bookdown**. There was not content of specific relevance for data visualization.

# References{-}
Xie, Y. (2023). bookdown: Authoring Books and Technical Documents with R Mardown. https://bookdown.org/yihui/bookdown/ (Status: May 08, 2023).

# Appendix A{-}
Example for an appendix

The following listing shows the data (do not do that with a large data set!).

```{r printdat}
print(swiss)
```

